name: Deploy Docs to Vercel

on:
  push:
    branches: [ main ]
    paths:
      - 'docs-site/**'
  workflow_dispatch:

env:
  # Vercelé…ç½® - ä¸å¾®å‰ç«¯é¡¹ç›®å…±ç”¨
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  # æ–‡æ¡£ç«™ç‚¹é¡¹ç›®ID
  VERCEL_PROJECT_ID_DOCS: ${{ secrets.VERCEL_PROJECT_ID_DOCS }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          cd docs-site
          npm ci
          npm list vitepress

      - name: Build
        run: |
          cd docs-site
          # æ„å»ºå‰æ¸…é™¤ç¼“å­˜
          rm -rf node_modules/.vite .vitepress/cache .vitepress/dist
          # ä½¿ç”¨NODE_OPTIONSå¢åŠ å†…å­˜é™åˆ¶
          NODE_OPTIONS=--max_old_space_size=4096 npm run docs:build
        env:
          # å¯ç”¨è¯¦ç»†æ—¥å¿—
          DEBUG: vitepress:*

      - name: Deploy to Vercel
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_DOCS }}
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
        shell: bash
        run: |
          set -e
          
          # è¿›å…¥æ–‡æ¡£ç«™ç‚¹ç›®å½•
          cd docs-site
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ ! -d ".vitepress/dist" ]; then
            echo "âŒ æ„å»ºå¤±è´¥: ç¼ºå°‘ .vitepress/dist ç›®å½•"
            exit 1
          fi
          
          # å®‰è£…Vercel CLI
          npm install --global vercel@latest
          
          # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„.vercelé…ç½®
          rm -rf .vercel || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ç”Ÿäº§éƒ¨ç½²
            echo "ğŸš€ Deploying docs to production..."
            URL=$(vercel . --prod --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "âœ… Production deployment: ${URL}"
          else
            # é¢„è§ˆéƒ¨ç½²
            echo "ğŸ”„ Deploying docs preview..."
            URL=$(vercel . --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "âœ… Preview deployment: ${URL}"
          fi