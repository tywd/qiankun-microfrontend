name: Deploy Docs to Vercel

on:
  push:
    branches: [ main ]
    paths:
      - 'docs-site/**'
  workflow_dispatch:

env:
  # Vercel配置 - 与微前端项目共用
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  # 文档站点项目ID
  VERCEL_PROJECT_ID_DOCS: ${{ secrets.VERCEL_PROJECT_ID_DOCS }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd docs-site
          npm install

      - name: Build
        run: |
          cd docs-site
          npm run docs:build

      - name: Deploy to Vercel
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_DOCS }}
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
        shell: bash
        run: |
          set -e
          
          # 进入文档站点目录
          cd docs-site
          
          # 安装Vercel CLI
          npm install --global vercel@latest
          
          # 清除可能存在的.vercel配置
          rm -rf .vercel || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # 生产部署
            echo "🚀 Deploying docs to production..."
            URL=$(vercel . --prod --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "✅ Production deployment: ${URL}"
          else
            # 预览部署
            echo "🔄 Deploying docs preview..."
            URL=$(vercel . --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "✅ Preview deployment: ${URL}"
          fi