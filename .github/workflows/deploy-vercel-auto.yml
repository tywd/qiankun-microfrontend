name: Auto Deploy to Vercel

# ğŸš€ Git Pushåè‡ªåŠ¨éƒ¨ç½²åˆ°Vercel
# æ”¯æŒä¸»åˆ†æ”¯æ¨é€å’ŒPull Requesté¢„è§ˆ
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # Vercelé…ç½®
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  # é¡¹ç›®IDï¼ˆéœ€è¦åœ¨GitHub Secretsä¸­é…ç½®ï¼‰
  VERCEL_PROJECT_ID_MAIN: ${{ secrets.VERCEL_PROJECT_ID_MAIN }}
  VERCEL_PROJECT_ID_USER: ${{ secrets.VERCEL_PROJECT_ID_USER }}
  VERCEL_PROJECT_ID_SYSTEM: ${{ secrets.VERCEL_PROJECT_ID_SYSTEM }}
  # Node.jsé…ç½®
  NODE_VERSION: '18'

jobs:
  # ğŸ” æ£€æµ‹å˜æ›´çš„åº”ç”¨
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      main-app-changed: ${{ steps.changes.outputs.main-app }}
      user-management-changed: ${{ steps.changes.outputs.user-management }}
      system-management-changed: ${{ steps.changes.outputs.system-management }}
      shared-changed: ${{ steps.changes.outputs.shared }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            main-app:
              - 'main-app/**'
            user-management:
              - 'sub-apps/user-management/**'
            system-management:
              - 'sub-apps/system-management/**'
            shared:
              - 'shared/**'
              - 'package.json'
              - 'pnpm-workspace.yaml'

  # ğŸ“¦ éƒ¨ç½²å­åº”ç”¨ - ç”¨æˆ·ç®¡ç†
  deploy-user-management:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.user-management-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true' || github.event_name == 'push'
    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      production-url: ${{ steps.deploy.outputs.production-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_USER }}
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
        shell: bash
        run: |
          set -e
          
          # è¿›å…¥å­åº”ç”¨ç›®å½•
          cd sub-apps/user-management
          
          # ç›´æ¥ä½¿ç”¨verceléƒ¨ç½²ï¼Œä¸ä½¿ç”¨link
          echo "ğŸš€ Starting deployment without link..."
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents: $(ls -la)"
          
          # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„.vercelé…ç½®
          rm -rf .vercel || true
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          vercel env add NODE_ENV production production --token="${{ env.VERCEL_TOKEN }}" || true
          vercel env add VITE_APP_BASE_URL /user production --token="${{ env.VERCEL_TOKEN }}" || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ç”Ÿäº§éƒ¨ç½² - æ˜¾å¼æŒ‡å®šå½“å‰ç›®å½•
            echo "ğŸš€ Deploying to production..."
            URL=$(vercel . --prod --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "production-url=${URL}" >> "$GITHUB_OUTPUT"
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Production deployment: ${URL}"
          else
            # é¢„è§ˆéƒ¨ç½² - æ˜¾å¼æŒ‡å®šå½“å‰ç›®å½•
            echo "ğŸ”„ Deploying preview..."
            URL=$(vercel . --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Preview deployment: ${URL}"
          fi

  # ğŸ“¦ éƒ¨ç½²å­åº”ç”¨ - ç³»ç»Ÿç®¡ç†
  deploy-system-management:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.system-management-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true' || github.event_name == 'push'
    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      production-url: ${{ steps.deploy.outputs.production-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_SYSTEM }}
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
        shell: bash
        run: |
          set -e
          
          # è¿›å…¥å­åº”ç”¨ç›®å½•
          cd sub-apps/system-management
          
          # ç›´æ¥ä½¿ç”¨verceléƒ¨ç½²ï¼Œä¸ä½¿ç”¨link
          echo "ğŸš€ Starting deployment without link..."
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents: $(ls -la)"
          
          # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„.vercelé…ç½®
          rm -rf .vercel || true
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          vercel env add NODE_ENV production production --token="${{ env.VERCEL_TOKEN }}" || true
          vercel env add VITE_APP_BASE_URL /system production --token="${{ env.VERCEL_TOKEN }}" || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ç”Ÿäº§éƒ¨ç½² - æ˜¾å¼æŒ‡å®šå½“å‰ç›®å½•
            echo "ğŸš€ Deploying to production..."
            URL=$(vercel . --prod --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "production-url=${URL}" >> "$GITHUB_OUTPUT"
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Production deployment: ${URL}"
          else
            # é¢„è§ˆéƒ¨ç½² - æ˜¾å¼æŒ‡å®šå½“å‰ç›®å½•
            echo "ğŸ”„ Deploying preview..."
            URL=$(vercel . --token="${{ env.VERCEL_TOKEN }}" --force)
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Preview deployment: ${URL}"
          fi

  # ğŸ“¦ éƒ¨ç½²ä¸»åº”ç”¨
  deploy-main-app:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-user-management, deploy-system-management]
    # ä¸»åº”ç”¨æ€»æ˜¯éœ€è¦éƒ¨ç½²ï¼Œå› ä¸ºå®ƒéœ€è¦çŸ¥é“å­åº”ç”¨çš„æœ€æ–°URL
    if: always() && !failure() && !cancelled()
    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      production-url: ${{ steps.deploy.outputs.production-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_MAIN }}
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
        shell: bash
        run: |
          set -e
          
          # è¿›å…¥ä¸»åº”ç”¨ç›®å½•
          cd main-app
          
          # ç›´æ¥ä½¿ç”¨verceléƒ¨ç½²ï¼Œä¸ä½¿ç”¨link
          echo "ğŸš€ Starting main app deployment without link..."
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents: $(ls -la)"
          
          # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„.vercelé…ç½®
          rm -rf .vercel || true
          
          # åŠ¨æ€è®¾ç½®å­åº”ç”¨URLç¯å¢ƒå˜é‡
          USER_URL="${{ needs.deploy-user-management.outputs.production-url || 'https://qiankun-user-management.vercel.app' }}"
          SYSTEM_URL="${{ needs.deploy-system-management.outputs.production-url || 'https://qiankun-system-management.vercel.app' }}"
          
          vercel env add VITE_USER_MANAGEMENT_URL "$USER_URL" production --token="${{ env.VERCEL_TOKEN }}" || true
          vercel env add VITE_SYSTEM_MANAGEMENT_URL "$SYSTEM_URL" production --token="${{ env.VERCEL_TOKEN }}" || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ç”Ÿäº§éƒ¨ç½² - å¼ºåˆ¶æŒ‡å®šé¡¹ç›®é…ç½®è¦†ç›–Vercelè®¾ç½®
            echo "ğŸš€ Deploying main app to production..."
            echo "ğŸ“ User Management URL: $USER_URL"
            echo "ğŸ“ System Management URL: $SYSTEM_URL"
            URL=$(vercel . --prod --token="${{ env.VERCEL_TOKEN }}" --force --scope="${{ env.VERCEL_ORG_ID }}" --project="${{ env.VERCEL_PROJECT_ID }}")
            echo "production-url=${URL}" >> "$GITHUB_OUTPUT"
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Main app production deployment: ${URL}"
          else
            # é¢„è§ˆéƒ¨ç½² - å¼ºåˆ¶æŒ‡å®šé¡¹ç›®é…ç½®è¦†ç›–Vercelè®¾ç½®
            echo "ğŸ”„ Deploying main app preview..."
            USER_PREVIEW_URL="${{ needs.deploy-user-management.outputs.preview-url || 'https://qiankun-user-management.vercel.app' }}"
            SYSTEM_PREVIEW_URL="${{ needs.deploy-system-management.outputs.preview-url || 'https://qiankun-system-management.vercel.app' }}"
            echo "ğŸ“ User Management Preview URL: $USER_PREVIEW_URL"
            echo "ğŸ“ System Management Preview URL: $SYSTEM_PREVIEW_URL"
            URL=$(vercel . --token="${{ env.VERCEL_TOKEN }}" --force --scope="${{ env.VERCEL_ORG_ID }}" --project="${{ env.VERCEL_PROJECT_ID }}")
            echo "url=${URL}" >> "$GITHUB_OUTPUT"
            echo "âœ… Main app preview deployment: ${URL}"
          fi

  # ğŸ’¬ é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-main-app, deploy-user-management, deploy-system-management]
    if: always() && !cancelled()
    steps:
      - name: Comment deployment status
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const mainUrl = '${{ needs.deploy-main-app.outputs.url }}';
            const userUrl = '${{ needs.deploy-user-management.outputs.url }}';
            const systemUrl = '${{ needs.deploy-system-management.outputs.url }}';
            
            let body = 'ğŸš€ **é¢„è§ˆéƒ¨ç½²å®Œæˆï¼**\n\n';
            body += 'ğŸ“ **é¢„è§ˆåœ°å€:**\n';
            if (mainUrl) body += `- ğŸ  ä¸»åº”ç”¨: ${mainUrl}\n`;
            if (userUrl) body += `- ğŸ‘¥ ç”¨æˆ·ç®¡ç†: ${userUrl}\n`;
            if (systemUrl) body += `- âš™ï¸ ç³»ç»Ÿç®¡ç†: ${systemUrl}\n`;
            body += '\nğŸ”— ç‚¹å‡»ä¸»åº”ç”¨é“¾æ¥å³å¯è®¿é—®å®Œæ•´çš„å¾®å‰ç«¯åº”ç”¨ï¼\n';
            body += '\n> ğŸ“ *æ­¤éƒ¨ç½²ä¸ºé¢„è§ˆç‰ˆæœ¬ï¼Œä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒ*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
      - name: Print production URLs
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‰ ç”Ÿäº§éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“ ä¸»åº”ç”¨: ${{ needs.deploy-main-app.outputs.production-url }}"
          echo "ğŸ“ ç”¨æˆ·ç®¡ç†: ${{ needs.deploy-user-management.outputs.production-url }}"
          echo "ğŸ“ ç³»ç»Ÿç®¡ç†: ${{ needs.deploy-system-management.outputs.production-url }}"