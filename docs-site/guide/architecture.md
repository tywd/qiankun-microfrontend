# é¡¹ç›®æ¶æ„

æœ¬é¡µé¢è¯¦ç»†ä»‹ç»äº†ä¼ä¸šçº§å¾®å‰ç«¯é¡¹ç›®çš„æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### å¾®å‰ç«¯æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·æµè§ˆå™¨"
        A[ä¸»åº”ç”¨ - Shell App<br/>localhost:8080]
    end
    
    subgraph "å­åº”ç”¨æœåŠ¡"
        B[ç”¨æˆ·ç®¡ç†å­åº”ç”¨<br/>localhost:8081]
        C[ç³»ç»Ÿç®¡ç†å­åº”ç”¨<br/>localhost:8082]
        D[å…¶ä»–å­åº”ç”¨...]
    end
    
    subgraph "å…±äº«èµ„æº"
        E[å…¬å…±ç»„ä»¶åº“]
        F[å·¥å…·å‡½æ•°åº“]
        G[ç±»å‹å®šä¹‰]
    end
    
    subgraph "åŸºç¡€è®¾æ–½"
        H[è·¯ç”±ç³»ç»Ÿ]
        I[çŠ¶æ€ç®¡ç†]
        J[æƒé™æ§åˆ¶]
        K[äº‹ä»¶æ€»çº¿]
    end
    
    A --> B
    A --> C
    A --> D
    
    E --> A
    E --> B
    E --> C
    
    H --> A
    I --> A
    J --> A
    K --> A
```

### æŠ€æœ¯é€‰å‹

| æŠ€æœ¯é¢†åŸŸ | é€‰æ‹©æ–¹æ¡ˆ | ç‰ˆæœ¬ | é€‰æ‹©åŸå›  |
|----------|----------|------|----------|
| **å¾®å‰ç«¯æ¡†æ¶** | Qiankun | 2.x | æˆç†Ÿç¨³å®šï¼Œç”Ÿæ€å®Œå–„ï¼Œé˜¿é‡Œå·´å·´å¼€æº |
| **å‰ç«¯æ¡†æ¶** | Vue 3 | 3.x | ç»„åˆå¼APIï¼Œæ€§èƒ½ä¼˜åŒ–ï¼ŒTypeScriptæ”¯æŒ |
| **æ„å»ºå·¥å…·** | Vite | 7.x | å¿«é€Ÿå¯åŠ¨ï¼ŒHMRï¼Œç°ä»£åŒ–æ„å»º |
| **ç±»å‹ç³»ç»Ÿ** | TypeScript | 5.x | ç±»å‹å®‰å…¨ï¼Œå¼€å‘ä½“éªŒï¼Œä»£ç è´¨é‡ |
| **UIç»„ä»¶åº“** | Element Plus | 2.x | Vue3å…¼å®¹ï¼Œä¼ä¸šçº§ç»„ä»¶ |
| **è·¯ç”±ç®¡ç†** | Vue Router | 4.x | å®˜æ–¹è·¯ç”±ï¼Œä¸Vue3æ·±åº¦é›†æˆ |
| **åŒ…ç®¡ç†å™¨** | pnpm | 8.x | ç£ç›˜æ•ˆç‡ï¼Œä¾èµ–ç®¡ç†ï¼ŒMonorepoæ”¯æŒ |
| **éƒ¨ç½²å¹³å°** | Vercel | - | è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒCDNåŠ é€Ÿï¼Œé›¶é…ç½® |

## ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™

### 1. ä¸»å­åº”ç”¨åˆ†ç¦»
- **æ¸…æ™°çš„ä¸šåŠ¡è¾¹ç•Œ**ï¼šæ¯ä¸ªå­åº”ç”¨è´Ÿè´£ç‹¬ç«‹çš„ä¸šåŠ¡é¢†åŸŸ
- **æŠ€æœ¯æ ˆç‹¬ç«‹**ï¼šå­åº”ç”¨å¯ä»¥é€‰æ‹©ä¸åŒçš„æŠ€æœ¯æ ˆï¼ˆå½“å‰ç»Ÿä¸€ä½¿ç”¨Vue3ï¼‰
- **ç‰ˆæœ¬ç®¡ç†ç‹¬ç«‹**ï¼šå„å­åº”ç”¨å¯ä»¥ç‹¬ç«‹è¿›è¡Œç‰ˆæœ¬è¿­ä»£

### 2. ç‹¬ç«‹å¼€å‘éƒ¨ç½²
- **å¼€å‘ç‹¬ç«‹æ€§**ï¼šå„å›¢é˜Ÿå¯ä»¥å¹¶è¡Œå¼€å‘ï¼Œå‡å°‘ä»£ç å†²çª
- **éƒ¨ç½²ç‹¬ç«‹æ€§**ï¼šå­åº”ç”¨å¯ä»¥å•ç‹¬éƒ¨ç½²ï¼Œä¸å½±å“å…¶ä»–åº”ç”¨
- **æµ‹è¯•ç‹¬ç«‹æ€§**ï¼šç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒå’Œæµ‹è¯•æµç¨‹

### 3. ç»Ÿä¸€åŸºç¡€è®¾æ–½
- **ç»Ÿä¸€çš„UIè§„èŒƒ**ï¼šä½¿ç”¨ç›¸åŒçš„è®¾è®¡ç³»ç»Ÿå’Œç»„ä»¶åº“
- **ç»Ÿä¸€çš„å¼€å‘è§„èŒƒ**ï¼šä»£ç è§„èŒƒã€Gitæäº¤è§„èŒƒç­‰
- **ç»Ÿä¸€çš„éƒ¨ç½²æµç¨‹**ï¼šæ ‡å‡†åŒ–çš„CI/CDæµç¨‹

### 4. é«˜æ•ˆé€šä¿¡æœºåˆ¶
- **Propsä¼ é€’**ï¼šä¸»åº”ç”¨å‘å­åº”ç”¨ä¼ é€’é…ç½®å’Œæ•°æ®
- **äº‹ä»¶æ€»çº¿**ï¼šè·¨åº”ç”¨çš„äº‹ä»¶é€šä¿¡
- **å…¨å±€çŠ¶æ€**ï¼šå…±äº«çŠ¶æ€ç®¡ç†
- **è·¯ç”±é€šä¿¡**ï¼šè·¨åº”ç”¨è·¯ç”±è·³è½¬

## ğŸ“ ç›®å½•ç»“æ„è®¾è®¡

### æ•´ä½“ç»“æ„

```
qiankun-microfrontend/
â”œâ”€â”€ main-app/                 # ä¸»åº”ç”¨ï¼ˆå£³åº”ç”¨ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/       # å…¬å…±ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Header/       # é¡¶éƒ¨å¯¼èˆª
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar/      # ä¾§è¾¹èœå•
â”‚   â”‚   â”‚   â””â”€â”€ Layout/       # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ micro/           # å¾®å‰ç«¯é…ç½® â­
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ apps.ts       # åº”ç”¨æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ router/          # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts      # ä¸»è·¯ç”±
â”‚   â”‚   â”‚   â””â”€â”€ guards.ts     # è·¯ç”±å®ˆå«
â”‚   â”‚   â”œâ”€â”€ shared/          # å…±äº«æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ eventBus.ts   # äº‹ä»¶æ€»çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/        # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â””â”€â”€ types/        # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ views/           # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard/    # ä»ªè¡¨æ¿
â”‚   â”‚   â”‚   â””â”€â”€ Layout/       # å¸ƒå±€é¡µé¢
â”‚   â”‚   â”œâ”€â”€ assets/          # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ styles/          # å…¨å±€æ ·å¼
â”‚   â”‚   â””â”€â”€ main.ts          # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ public/              # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ vite.config.ts       # Viteé…ç½®
â”‚   â”œâ”€â”€ tsconfig.json        # TypeScripté…ç½®
â”‚   â””â”€â”€ package.json         # ä¾èµ–é…ç½®
â”œâ”€â”€ sub-apps/                # å­åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ user-management/     # ç”¨æˆ·ç®¡ç†å­åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/  # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ views/       # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ router/      # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ api/         # æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/      # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/       # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ types/       # ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ main.ts      # å…¥å£æ–‡ä»¶ â­
â”‚   â”‚   â”œâ”€â”€ vite.config.ts   # Viteé…ç½® â­
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ system-management/   # ç³»ç»Ÿç®¡ç†å­åº”ç”¨
â”‚       â””â”€â”€ ...             # ç»“æ„åŒç”¨æˆ·ç®¡ç†
â”œâ”€â”€ shared/                  # å…±äº«èµ„æºï¼ˆå·²åºŸå¼ƒï¼‰
â”œâ”€â”€ scripts/                 # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ docker/                  # Dockeré…ç½®
â”œâ”€â”€ nginx/                   # Nginxé…ç½®
â”œâ”€â”€ docs/                    # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ docs-site/               # VitePressæ–‡æ¡£ç«™ç‚¹
â”œâ”€â”€ .github/workflows/       # CI/CDé…ç½®
â”œâ”€â”€ .vscode/                 # VSCodeé…ç½®
â”œâ”€â”€ .eslintrc.js             # ESLinté…ç½®
â”œâ”€â”€ .prettierrc              # Prettieré…ç½®
â”œâ”€â”€ tsconfig.json            # TypeScriptæ ¹é…ç½®
â””â”€â”€ package.json             # æ ¹é…ç½®æ–‡ä»¶
```

### ä¸»åº”ç”¨ç»“æ„ç‰¹ç‚¹

- **micro/ç›®å½•**ï¼šæ ¸å¿ƒçš„å¾®å‰ç«¯é…ç½®ï¼Œè´Ÿè´£å­åº”ç”¨çš„æ³¨å†Œå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **shared/ç›®å½•**ï¼šå†…éƒ¨å…±äº«æ¨¡å—ï¼Œé¿å…å¤–éƒ¨ä¾èµ–
- **components/ç›®å½•**ï¼šå…¨å±€å…¬å…±ç»„ä»¶ï¼Œä¸ºæ‰€æœ‰å­åº”ç”¨æä¾›ç»Ÿä¸€çš„UIç»„ä»¶

### å­åº”ç”¨ç»“æ„ç‰¹ç‚¹

- **ç‹¬ç«‹çš„package.json**ï¼šæ¯ä¸ªå­åº”ç”¨éƒ½æœ‰ç‹¬ç«‹çš„ä¾èµ–ç®¡ç†
- **main.ts**ï¼šå¯¼å‡ºqiankunç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ŒåŒæ—¶æ”¯æŒç‹¬ç«‹è¿è¡Œ
- **router/ç›®å½•**ï¼šå­åº”ç”¨çš„è·¯ç”±é…ç½®ï¼Œéœ€è¦è€ƒè™‘ä¸»åº”ç”¨çš„è·¯ç”±å‰ç¼€

## ğŸ”„ åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

### Qiankunç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant Main as ä¸»åº”ç”¨
    participant Sub as å­åº”ç”¨
    
    Main->>Sub: 1. åŠ è½½å­åº”ç”¨
    Sub->>Sub: 2. bootstrap()
    Sub-->>Main: å¯åŠ¨å®Œæˆ
    
    Main->>Sub: 3. æŒ‚è½½å­åº”ç”¨
    Sub->>Sub: 4. mount(props)
    Sub-->>Main: æŒ‚è½½å®Œæˆ
    
    Note over Main,Sub: ç”¨æˆ·æ“ä½œï¼Œåº”ç”¨è¿è¡Œ
    
    Main->>Sub: 5. å¸è½½å­åº”ç”¨
    Sub->>Sub: 6. unmount()
    Sub-->>Main: å¸è½½å®Œæˆ
```

### ç”Ÿå‘½å‘¨æœŸå®ç°

```typescript
// å­åº”ç”¨ main.ts
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'

let app: any = null

// qiankunç”Ÿå‘½å‘¨æœŸ - å¯åŠ¨
export async function bootstrap() {
  console.log('[ç”¨æˆ·ç®¡ç†] åº”ç”¨å¯åŠ¨')
}

// qiankunç”Ÿå‘½å‘¨æœŸ - æŒ‚è½½
export async function mount(props: any) {
  console.log('[ç”¨æˆ·ç®¡ç†] åº”ç”¨æŒ‚è½½', props)
  
  app = createApp(App)
  app.use(router)
  
  const container = props.container 
    ? props.container.querySelector('#app') 
    : '#app'
  
  app.mount(container)
}

// qiankunç”Ÿå‘½å‘¨æœŸ - å¸è½½
export async function unmount() {
  console.log('[ç”¨æˆ·ç®¡ç†] åº”ç”¨å¸è½½')
  app?.unmount()
  app = null
}

// ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  mount({})
}
```

## ğŸŒ è·¯ç”±æ¶æ„

### è·¯ç”±è®¾è®¡æ¨¡å¼

```mermaid
graph TD
    A[ä¸»åº”ç”¨è·¯ç”±] --> B[/dashboard - ä»ªè¡¨æ¿]
    A --> C[/user/* - ç”¨æˆ·ç®¡ç†]
    A --> D[/system/* - ç³»ç»Ÿç®¡ç†]
    
    C --> E[ç”¨æˆ·ç®¡ç†å­åº”ç”¨è·¯ç”±]
    E --> F[/user/list - ç”¨æˆ·åˆ—è¡¨]
    E --> G[/user/detail/:id - ç”¨æˆ·è¯¦æƒ…]
    E --> H[/user/add - æ·»åŠ ç”¨æˆ·]
    
    D --> I[ç³»ç»Ÿç®¡ç†å­åº”ç”¨è·¯ç”±]
    I --> J[/system/settings - ç³»ç»Ÿè®¾ç½®]
    I --> K[/system/logs - æ“ä½œæ—¥å¿—]
    I --> L[/system/permissions - æƒé™ç®¡ç†]
```

### è·¯ç”±é…ç½®ç¤ºä¾‹

**ä¸»åº”ç”¨è·¯ç”±é…ç½®**ï¼š
```typescript
// main-app/src/router/index.ts
const routes = [
  {
    path: '/',
    redirect: '/dashboard'
  },
  {
    path: '/dashboard',
    component: Dashboard
  },
  {
    // å¾®å‰ç«¯è·¯ç”±é€šé…ç¬¦
    path: '/user/:pathMatch(.*)*',
    component: MicroApp
  },
  {
    path: '/system/:pathMatch(.*)*', 
    component: MicroApp
  }
]
```

**å­åº”ç”¨è·¯ç”±é…ç½®**ï¼š
```typescript
// sub-apps/user-management/src/router/index.ts
const routes = [
  {
    path: '/user',
    redirect: '/user/list'
  },
  {
    path: '/user/list',
    component: UserList
  },
  {
    path: '/user/detail/:id',
    component: UserDetail
  }
]

// è·¯ç”±åŸºç¡€è·¯å¾„é…ç½®
const router = createRouter({
  history: createWebHistory(
    window.__POWERED_BY_QIANKUN__ ? '/user' : '/'
  ),
  routes
})
```

## ğŸ”— é€šä¿¡æ¶æ„

### é€šä¿¡æ–¹å¼å¯¹æ¯”

| é€šä¿¡æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|----------|----------|------|------|
| **Propsä¼ é€’** | ä¸»åº”ç”¨â†’å­åº”ç”¨ | ç®€å•ç›´æ¥ï¼Œç±»å‹å®‰å…¨ | å•å‘ä¼ é€’ï¼Œæ•°æ®é‡æœ‰é™ |
| **äº‹ä»¶æ€»çº¿** | è·¨åº”ç”¨é€šä¿¡ | è§£è€¦æ€§å¥½ï¼Œæ”¯æŒå¤šå¯¹å¤š | è°ƒè¯•å›°éš¾ï¼Œç±»å‹æ£€æŸ¥å¼± |
| **å…¨å±€çŠ¶æ€** | å…±äº«æ•°æ® | æ•°æ®ä¸€è‡´æ€§å¥½ | çŠ¶æ€ç®¡ç†å¤æ‚ |
| **URLå‚æ•°** | é¡µé¢é—´è·³è½¬ | å¯æŒä¹…åŒ–ï¼ŒSEOå‹å¥½ | æ•°æ®ç±»å‹å—é™ |

### äº‹ä»¶æ€»çº¿å®ç°

```typescript
// main-app/src/shared/eventBus.ts
class EventBus {
  private events: Record<string, Function[]> = {}
  
  // è®¢é˜…äº‹ä»¶
  on(event: string, callback: Function) {
    if (!this.events[event]) {
      this.events[event] = []
    }
    this.events[event].push(callback)
  }
  
  // å‘å¸ƒäº‹ä»¶
  emit(event: string, ...args: any[]) {
    if (!this.events[event]) return
    this.events[event].forEach(callback => {
      callback(...args)
    })
  }
  
  // å–æ¶ˆè®¢é˜…
  off(event: string, callback?: Function) {
    if (!this.events[event]) return
    if (callback) {
      this.events[event] = this.events[event].filter(cb => cb !== callback)
    } else {
      delete this.events[event]
    }
  }
}

export const globalEventBus = new EventBus()
```

## ğŸ›¡ï¸ æ ·å¼éš”ç¦»

### æ ·å¼éš”ç¦»ç­–ç•¥

1. **qiankunæ²™ç®±æœºåˆ¶**ï¼šè‡ªåŠ¨éš”ç¦»JSå’ŒCSS
2. **CSS Modules**ï¼šç»„ä»¶çº§æ ·å¼éš”ç¦»
3. **å‘½åç©ºé—´**ï¼šä¸ºæ¯ä¸ªåº”ç”¨æ·»åŠ å”¯ä¸€å‰ç¼€
4. **Shadow DOM**ï¼šå®Œå…¨éš”ç¦»çš„æ ·å¼ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

### å®ç°ç¤ºä¾‹

```vue
<!-- å­åº”ç”¨ç»„ä»¶æ ·å¼éš”ç¦» -->
<template>
  <div class="user-management">
    <h1 class="title">ç”¨æˆ·ç®¡ç†</h1>
  </div>
</template>

<style scoped>
.user-management {
  /* æ ·å¼åªä½œç”¨äºå½“å‰ç»„ä»¶ */
  padding: 20px;
}

.title {
  color: #333;
  font-size: 24px;
}
</style>
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æ¶æ„

### ä¼˜åŒ–ç­–ç•¥

1. **æŒ‰éœ€åŠ è½½**ï¼šå­åº”ç”¨æ‡’åŠ è½½ï¼Œå‡å°‘åˆå§‹åŒ…å¤§å°
2. **é¢„åŠ è½½**ï¼šæ™ºèƒ½é¢„åŠ è½½å³å°†è®¿é—®çš„å­åº”ç”¨
3. **å…±äº«ä¾èµ–**ï¼šæŠ½å–å…¬å…±ä¾èµ–ï¼Œé¿å…é‡å¤åŠ è½½
4. **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†é…ç½®æµè§ˆå™¨ç¼“å­˜å’ŒCDNç¼“å­˜

### åŠ è½½ä¼˜åŒ–

```typescript
// é¢„åŠ è½½ç­–ç•¥
const preloadApps = ['user-management']

// åœ¨é€‚å½“æ—¶æœºé¢„åŠ è½½
function preloadMicroApps() {
  preloadApps.forEach(name => {
    import(/* webpackChunkName: "[request]" */ `../micro/${name}`)
  })
}

// è·¯ç”±å®ˆå«ä¸­è§¦å‘é¢„åŠ è½½
router.beforeEach((to, from, next) => {
  if (shouldPreload(to.path)) {
    preloadMicroApps()
  }
  next()
})
```

---

é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ï¼Œæœ¬é¡¹ç›®å®ç°äº†çœŸæ­£çš„å¾®å‰ç«¯åº”ç”¨ï¼Œä¸ºä¼ä¸šçº§åº”ç”¨å¼€å‘æä¾›äº†å®Œæ•´ã€å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆã€‚